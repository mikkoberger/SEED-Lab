#include <Encoder.h>
#include <Wire.h>

#define SLAVE_ADDRESS 0x04
// Defining general variables and designating voltage pins
int voltagePin = 9;
int pwmOutput;
int enablePin = 4;
int Direction = 7;
double sampleRate = 0.05;
double Delay = sampleRate * 1000;
double ki = 0.65;//0.07;//5.715; //39.2786869994445; //16;
double kp = 1.2; //0.7;//4.75; //14.7576110544375; //12;
double kd = 0.07; //1.2;//.53; //0.967168289862824; // 0.7;
double thetaNew;
double thetaDesired = 0;
int received_int;
int thetaSend;
int dummy;


unsigned long currentTime, previousTime;
double elapsedTime;
double error;
double lastError;
double input, output, setPoint;
double cumError, rateError;
Encoder encoder(3, 6);

void setup() {
  Serial.begin(9600);
  pinMode(enablePin, OUTPUT);
  digitalWrite(enablePin, HIGH);
  pinMode(voltagePin, OUTPUT);
  pinMode(Direction, OUTPUT);
  digitalWrite(Direction, LOW);

  // Pi I2C stuff
  pinMode(13, OUTPUT);
  Wire.begin(SLAVE_ADDRESS);
  
}//42


void loop() {
  Wire.onReceive(receiveData);
  thetaNew = (6.2832/3200)*encoder.read();
  Serial.print(thetaNew);
  dummy = encoder.read();
  if(received_int == 1){
    thetaDesired = 1.57;
    //Serial.print("Entered 1");
  }else if(received_int == 2){
    thetaDesired = 3.14;
    //Serial.print("Entered 2");
  }else if(received_int == 3){
    thetaDesired = 4.71;
    //Serial.print("Entered 3");
  }else if(received_int == 4){
    thetaDesired = 6.28;
    //Serial.print("Entered 4");
  }
  pwmOutput = (255/8)*PIDmotorcontroller(thetaNew);
  delay(Delay);
  analogWrite(voltagePin, pwmOutput);
  //thetaSend = encoder.read();
  Wire.onRequest(sendData);
  //Serial.print(thetaSend);
}



double PIDmotorcontroller(double thetaNew){
    currentTime = millis();
    elapsedTime = (double)(currentTime - previousTime)/1000;
    double out;
    error = (thetaDesired - thetaNew);
   
    //Serial.println(error);
       
    cumError += (error * elapsedTime);
    rateError = (error - lastError) / elapsedTime;
    out = (kp * error) + (ki * cumError) + (kd * rateError);

    if(out > 0){
      digitalWrite(Direction, HIGH);
      //Serial.print("high");
    } else{
      digitalWrite(Direction, LOW);
     // Serial.print("low");
    }

    out = abs(out);
   
    if(out > 8){
      out = 8;
    }
    //Serial.println(out);
    lastError = error;
    previousTime = currentTime;

    return out;
 
}

void receiveData(){
  while(Wire.available()){
    received_int = Wire.read();
    Serial.print(received_int);
  }
}

void sendData(){
  //Wire.beginTransmission(SLAVE_ADDRESS);
  thetaSend = int(10*thetaNew);
  Serial.println(thetaSend);
  Serial.println(thetaNew);
  Serial.println(dummy);
  Wire.write(thetaSend);
  
  //Wire.endTransmission();
}
